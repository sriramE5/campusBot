<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Aditya University - Campus Map</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #eaeaea;
            --text-primary: #1a1a1a;
            --accent-primary: #0C6AB0;
            --border-color: #cccccc;
            --header-height: 60px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg);
            color: var(--text-primary);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
            height: var(--header-height);
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--accent-primary);
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 1.5rem;
        }

        nav a {
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 500;
            transition: color 0.3s;
        }

        nav a:hover, nav a.active {
            color: var(--accent-primary);
        }

        .map-container {
            margin-top: var(--header-height);
            height: calc(100vh - var(--header-height));
            width: 100%;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .location-list {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1rem;
            width: 300px;
            max-height: calc(100% - 40px);
            overflow-y: auto;
            z-index: 1000;
        }

        .location-list h3 {
            margin-bottom: 1rem;
            color: var(--accent-primary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .location-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--bg-secondary);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .location-item:hover {
            background-color: var(--bg-secondary);
        }

        .location-item.active {
            font-weight: bold;
            color: var(--accent-primary);
        }

        .search-box {
            margin-bottom: 1rem;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .search-box i {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .location-list {
                position: static;
                width: 100%;
                max-height: 200px;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
                border-bottom: 1px solid var(--border-color);
            }

            .map-container {
                margin-top: 0;
                height: calc(100vh - var(--header-height) - 200px);
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <div class="logo">Aditya University</div>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="locations.html" class="active">Campus Map</a></li>
                </ul>
            </nav>
        </div>
       
    </header>

    <div class="map-container">
        <div id="map"></div>
        <div class="location-list">
            <h3>Campus Locations</h3>
            <div class="search-box">
                <input type="text" id="location-search" placeholder="Search locations...">
                <i class="fas fa-search"></i>
            </div>
            <div id="locations-list">
                <!-- Locations will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Campus locations data - these should match your event locations
        // Ordered with bhavans and key locations first
        const locations = [
            // Bhavans (in priority order)
            { id: 'ratan-tata', name: 'Ratan Tata Bhavan', lat: 17.087863167643086, lng: 82.06640399381214 },
            { id: 'cotton', name: 'Cotton Bhavan', lat: 17.08792469891925, lng: 82.0668492406757 },
            { id: 'kl-rao', name: 'KL Rao Bhavan', lat: 17.08890919657121, lng: 82.06705845281687 },
            { id: 'billgates', name: 'Billgates Bhavan', lat: 17.0895245049695, lng: 82.06707991051587 },
            { id: 'viswesaraya', name: 'Viswesaraya Bhavan', lat: 17.090447463751605, lng: 82.06692434252517 },
            { id: 'bhaskara-bhavan', name: 'Bhaskara Bhavan', lat: 17.091029333837017, lng: 82.06613436325006 },
            { id: 'cv-raman', name: 'CV Raman Bhavan', lat: 17.091452458111533, lng: 82.06682241841239 },
            { id: 'ramanujan', name: 'Ramanujan Bhavan', lat: 17.09275484072352, lng: 82.06666148586086 },
            { id: 'james-watt', name: 'James Watt Bhavan', lat: 17.092918919774487, lng: 82.06620014588847 },
            { id: 'newton', name: 'Newton Bhavan', lat: 17.093626509026613, lng: 82.06654346865862 },
            { id: 'edison', name: 'Edison Bhavan', lat: 17.090201341863114, lng: 82.07086718971647 },
            { id: 'abdul-kalam-bhavan', name: 'Abdul Kalam Bhavan', lat: 17.08977821473724, lng: 82.07054391507901 },
            
            // Key academic and administrative buildings
            { id: 'agbs', name: 'AGBS', lat: 17.089596290822936, lng: 82.07173622547839 },
            { id: 'polytechnic-college', name: 'Polytechnic College', lat: 17.08892703873516, lng: 82.07224980012961 },
            { id: 'technical-hub', name: 'Technical Hub', lat: 17.087740105019247, lng: 82.06886089733018 },
            
            // Hostels
            { id: 'boys-hostel', name: 'Boys Hostel', lat: 17.091773169636863, lng: 82.06917498393841 },
            { id: 'girl-hostel', name: 'Girl Hostel', lat: 17.08802725099051, lng: 82.07067407070998 },
            
            // Grounds and outdoor areas
            { id: 'kl-rao-ground', name: 'KL Rao Ground', lat: 17.088957804210455, lng: 82.06792607895672 },
            { id: 'bped-ground', name: 'BPED Ground', lat: 17.09112162917562, lng: 82.0721317828909 },
            { id: 'gallery-ground', name: 'Gallery Ground', lat: 17.089860255581016, lng: 82.0688916742842 },
            { id: 'bus-ground', name: 'Bus Ground', lat: 17.091008823745277, lng: 82.0707692206834 },
            
            // Other locations
            { id: 'gallery', name: 'Gallery', lat: 17.089676360656743, lng: 82.06756416422398 },
            { id: 'mango-garden', name: 'Mango Garden', lat: 17.090844743012365, lng: 82.06845179198498 },
            { id: 'apollo', name: 'Apollo Sunshine Health Care', lat: 17.08973986243556, lng: 82.07053459575654 },
            { id: 'temple', name: 'Temple', lat: 17.09074766689225, lng: 82.06951294240847 }
        ];

        // Initialize map variables
        let map;
        let markers = [];
        let activeLocation = null;
        let events = []; // Will store events from the backend
        const API_BASE_URL = 'http://127.0.0.1:8000'; // Match this with your backend URL
        
        // Initialize the map after DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            map = L.map('map').setView([17.090489589089355, 82.06848498587007], 17);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Initialize markers and load events
            addMarkers();
            loadEvents();
            
            // Add click handler for event items to toggle details
            document.addEventListener('click', function(e) {
                const eventSummary = e.target.closest('.event-summary');
                if (eventSummary) {
                    const eventItem = eventSummary.parentElement;
                    eventItem.classList.toggle('expanded');
                    
                    // Close other expanded items
                    if (eventItem.classList.contains('expanded')) {
                        document.querySelectorAll('.event-item.expanded').forEach(expandedItem => {
                            if (expandedItem !== eventItem) {
                                expandedItem.classList.remove('expanded');
                            }
                        });
                    }
                }
            });
        });

        // Function to get events for a specific location
        function getEventsForLocation(locationName) {
            return events.filter(event => 
                event.location.toLowerCase() === locationName.toLowerCase()
            );
        }

        // Format date as dd/mm/yy
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);
            return `${day}/${month}/${year}`;
        }

        // Function to create popup content with events
        function createPopupContent(location) {
            const locationEvents = getEventsForLocation(location.name);
            let content = `<b>${location.name}</b>`;
            
            if (locationEvents.length > 0) {
                content += '<div class="location-events"><h4>Upcoming Events:</h4><ul>';
                locationEvents.forEach(event => {
                    const eventDate = event.date ? formatDate(event.date) : 'No date';
                    content += `
                        <li class="event-item">
                            <div class="event-summary">
                                <strong>${event.name}</strong>
                                <small>${eventDate}</small>
                                <span class="toggle-details"><i class="fas fa-chevron-down"></i></span>
                            </div>
                            <div class="event-details">
                                ${event.details ? `<div class="event-description">${event.details}</div>` : ''}
                                ${event.image_url ? `
                                <a href="${event.image_url}" target="_blank" class="view-image">
                                    <i class="fas fa-image"></i> View Image
                                </a>` : ''}
                            </div>
                        </li>`;
                });
                content += '</ul></div>';
            } 
            
            return content;
        }

        // Function to add markers to the map
        function addMarkers() {
            locations.forEach(location => {
                const marker = L.marker([location.lat, location.lng], {
                    title: location.name
                }).addTo(map);
                
                // Bind popup with events
                marker.bindPopup(createPopupContent(location));
                
                // Store reference to marker
                markers.push({
                    id: location.id,
                    marker: marker,
                    name: location.name,
                    location: location
                });
                
                // Add to locations list
                const locationItem = document.createElement('div');
                locationItem.className = 'location-item';
                locationItem.textContent = location.name;
                locationItem.dataset.id = location.id;
                
                // Add event count badge if there are events
                const locationEvents = getEventsForLocation(location.name);
                if (locationEvents.length > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'event-badge';
                    badge.textContent = locationEvents.length;
                    locationItem.appendChild(badge);
                }
                
                locationItem.addEventListener('click', () => {
                    // Center map on selected location
                    map.setView([location.lat, location.lng], 18);
                    
                    // Highlight selected location
                    document.querySelectorAll('.location-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    locationItem.classList.add('active');
                    
                    // Open popup
                    marker.openPopup();
                });
                
                document.getElementById('locations-list').appendChild(locationItem);
            });
        }

        // Function to update popups with latest events
        function updatePopups() {
            markers.forEach(markerData => {
                const location = locations.find(loc => loc.id === markerData.id);
                if (location) {
                    markerData.marker.setPopupContent(createPopupContent(location));
                }
            });
        }

        // Load events from backend
        async function loadEvents() {
            try {
                const response = await fetch(`${API_BASE_URL}/events`);
                if (!response.ok) throw new Error('Failed to load events');
                events = await response.json();
                updatePopups();
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        // Search functionality
        document.getElementById('location-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const locationItems = document.querySelectorAll('.location-item');
            
            locationItems.forEach(item => {
                const locationName = item.textContent.toLowerCase();
                if (locationName.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // Add some styles for event items in popups
        const style = document.createElement('style');
        style.textContent = `
            /* Event popup styles */
            .location-events {
                margin-top: 12px;
                max-height: 300px;
                overflow-y: auto;
                padding: 8px;
                border-radius: 8px;
                background-color: #f8f9fa;
            }
            
            .event-item {
                padding: 0;
                margin: 8px 0;
                border-radius: 8px;
                font-size: 0.9em;
                background-color: white;
                border: 1px solid #e0e0e0;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                overflow: hidden;
                transition: transform 0.2s, box-shadow 0.2s;
            }
            
            .event-item:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            
            .event-summary {
                padding: 12px;
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: background-color 0.2s;
            }
            
            .event-summary:hover {
                background-color: #f8f9fa;
            }
            
            .event-summary .toggle-details {
                color: #666;
                transition: transform 0.2s;
            }
            
            .event-item.expanded .toggle-details {
                transform: rotate(180deg);
            }
            
            .event-details {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease-out;
                padding: 0 12px;
                border-top: 1px solid transparent;
            }
            
            .event-item.expanded .event-details {
                max-height: 1000px;
                padding: 0 12px 12px;
                border-top: 1px solid #eee;
            }
            
            .event-description {
                margin: 8px 0 12px;
                line-height: 1.5;
            }
            
            .event-item strong {
                color: var(--accent-primary);
                display: block;
                margin-bottom: 4px;
                font-size: 1.05em;
            }
            
            .event-item small {
                color: #666;
                font-size: 0.85em;
                display: block;
                margin-bottom: 6px;
            }
            
            .view-image {
                display: inline-block;
                margin-top: 6px;
                color: var(--accent-primary);
                text-decoration: none;
                font-size: 0.85em;
                font-weight: 500;
            }
            
            .view-image:hover {
                text-decoration: underline;
            }
            
            .event-badge {
                background-color: var(--accent-primary);
                color: white;
                border-radius: 10px;
                padding: 2px 8px;
                font-size: 0.7em;
                margin-left: 8px;
                vertical-align: middle;
            }
        `;
        document.head.appendChild(style);
        
        // Function to handle URL parameters for location highlighting
        function checkUrlForLocation() {
            const params = new URLSearchParams(window.location.search);
            const locationId = params.get('location');
            if (locationId) {
                const markerData = markers.find(m => m.id === locationId);
                if (markerData) {
                    const location = markerData.location;
                    map.setView([location.lat, location.lng], 18);
                    markerData.marker.openPopup();
                    
                    // Highlight in the list
                    const locationItems = document.querySelectorAll('.location-item');
                    locationItems.forEach(item => {
                        item.classList.remove('active');
                        if (item.dataset.id === locationId) {
                            item.classList.add('active');
                            item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    });
                }
            }
        }
        
        // Function to focus on a specific location
        function focusLocation(locationId) {
            if (!locationId) {
                console.error('No location ID provided for focusing');
                return false;
            }
            
            // Try to find the location in the sidebar list first
            let locationElement = document.querySelector(`.location-item[data-id="${locationId}"]`);
            
            // If not found in sidebar, try to find by ID
            if (!locationElement) {
                locationElement = document.getElementById(locationId);
            }
            
            // If element not found, it might be because the map is not fully loaded yet
            if (!locationElement) {
                console.log(`Location element ${locationId} not found, will retry...`);
                // Try again after a short delay
                setTimeout(() => focusLocation(locationId), 500);
                return false;
            }
            
            try {
                // Update URL without adding to browser history
                history.replaceState(null, null, `#${locationId}`);
                
                // Scroll to the location in the sidebar
                locationElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Highlight the location in the sidebar
                document.querySelectorAll('.location-item').forEach(item => {
                    item.classList.remove('active');
                });
                locationElement.classList.add('active');
                
                // Find the corresponding marker and open its popup
                const marker = markers.find(m => m.id === locationId);
                if (marker) {
                    map.setView(marker.marker.getLatLng(), 18);
                    marker.marker.openPopup();
                    showLocationDetails(marker.location);
                }
                
                console.log(`Focused on location: ${locationId}`);
                return true;
            } catch (error) {
                console.error('Error focusing on location:', error);
                return false;
            }
        }
        
        // Make it available globally
        window.focusOnLocation = focusLocation;
        
        // Check for location in URL when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Function to handle location focusing
            const handleLocationFocus = () => {
                // First check URL hash
                if (window.location.hash) {
                    const locationId = window.location.hash.substring(1);
                    if (focusLocation(locationId)) {
                        return;
                    }
                }
                
                // Then check session storage (in case we came from index.html)
                const savedLocation = sessionStorage.getItem('focusLocation');
                if (savedLocation) {
                    if (focusLocation(savedLocation)) {
                        // Clear the saved location after using it
                        sessionStorage.removeItem('focusLocation');
                        return;
                    }
                }
            };
            
            // Initial check after a short delay to ensure map is loaded
            setTimeout(handleLocationFocus, 500);
            
            // Also handle hash changes
            window.addEventListener('hashchange', handleLocationFocus);
        });
    </script>
</body>
</html>
